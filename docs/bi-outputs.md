# Business Intelligence & Tableau Guide

This document explains all BI outputs generated by the pipeline — what each file contains, how to use them in Tableau, and how the executive KPI summary is structured.

---

## Overview

The pipeline generates three types of BI outputs:

```
outputs/
├── tableau/                   ← Import directly into Tableau
│   ├── churn_analysis_tableau.csv    (100K rows - full dataset)
│   ├── segment_summary.csv           (4 rows - segment profiles)
│   └── executive_kpi.csv             (1 row - top-level KPIs)
│
├── reports/                   ← Machine-readable reports
│   ├── model_comparison.csv          (model performance comparison)
│   ├── model_comparison.json         (detailed metrics with confusion matrices)
│   ├── segment_profiles.csv          (cluster analysis results)
│   └── executive_kpi_summary.json    (complete KPI package)
│
└── visualizations/            ← Ready-to-use chart images
    ├── confusion_matrix_*.png        (3 files)
    ├── roc_curves_comparison.png
    ├── feature_importance_xgboost.png
    ├── elbow_method.png
    ├── silhouette_analysis.png
    └── churn_distribution.png
```

**File:** `src/utils/bi_output.py`

---

## Tableau-Ready Datasets

### 1. churn_analysis_tableau.csv

**Location:** `outputs/tableau/churn_analysis_tableau.csv`
**Rows:** 100,000 (one per customer)
**Purpose:** The primary dataset for building Tableau dashboards.

**Columns include:**

| Column Group | Examples | Use In Tableau |
|-------------|---------|---------------|
| Demographics | `gender`, `age`, `partner`, `num_dependents` | Filters, demographic breakdown |
| Account | `tenure_months`, `contract_type` | Time-series analysis, contract analysis |
| Billing | `monthly_charges`, `total_charges`, `payment_method` | Revenue analysis, payment patterns |
| Services | `internet_service`, `online_security`, `streaming_tv` | Service adoption analysis |
| Usage | `monthly_minutes_used`, `data_usage_gb`, `num_support_tickets` | Usage patterns, support analysis |
| Target | `churn` (0/1) | Color coding, filtering, KPI calculation |
| Segment | `customer_segment` (0-3) | Segment comparison, drill-down |

**Tableau dashboard ideas:**
- Churn rate by contract type (bar chart)
- Monthly charges distribution by churn status (box plot)
- Customer segments by tenure and charges (scatter plot)
- Service adoption vs. churn rate (heat map)
- Geographic/demographic churn patterns (if you add location data)

### 2. segment_summary.csv

**Location:** `outputs/tableau/segment_summary.csv`
**Rows:** 4 (one per segment)
**Purpose:** Pre-aggregated segment profiles for quick reference.

**Columns:**

| Column | Example Value | Description |
|--------|-------------|-------------|
| `segment` | 0, 1, 2, 3 | Cluster ID |
| `count` | 29,297 | Number of customers in segment |
| `avg_tenure` | 13.47 | Average tenure in months |
| `avg_monthly_charges` | 92.70 | Average monthly bill |
| `avg_total_charges` | 1,239.86 | Average lifetime charges |
| `avg_support_tickets` | 1.48 | Average support tickets |
| `avg_minutes` | 451.21 | Average monthly minutes |
| `avg_data_gb` | 5.63 | Average data usage in GB |
| `churn_rate` | 0.697 | Proportion of segment that churned |
| `business_label` | "At-Risk / High Spenders" | Human-readable segment name |

**Tableau use:** Create a segment comparison dashboard with bar charts, showing KPIs side-by-side for each segment.

### 3. executive_kpi.csv

**Location:** `outputs/tableau/executive_kpi.csv`
**Rows:** 1
**Purpose:** Top-level KPIs for executive dashboard tiles.

**Columns:**

| Column | Example Value | Dashboard Tile |
|--------|-------------|---------------|
| `Total Customers` | 100,000 | Big number tile |
| `Churn Rate` | 0.498 | Percentage gauge |
| `Avg Monthly Revenue` | 69.13 | Dollar amount tile |
| `Total Revenue` | 6,721,234.56 | Dollar amount tile |
| `At-Risk Customers` | 49,831 | Warning indicator |
| `Revenue At Risk (Annual)` | 43,568,166.96 | Dollar amount (red) |
| `Best Model` | "xgboost" | Text label |
| `Model ROC-AUC` | 0.9328 | Performance indicator |
| `Model Accuracy` | 0.8508 | Percentage gauge |

---

## Building Tableau Dashboards

### Step 1: Connect to Data

1. Open Tableau Desktop
2. Click **Connect** → **Text file**
3. Select `outputs/tableau/churn_analysis_tableau.csv`
4. Tableau will auto-detect data types

### Step 2: Recommended Visualizations

#### Dashboard 1: Churn Overview

| Chart | Type | Dimensions | Measures |
|-------|------|-----------|----------|
| Churn Distribution | Bar Chart | `churn` | COUNT |
| Churn by Contract | Stacked Bar | `contract_type`, `churn` | COUNT |
| Monthly Charges | Histogram | `monthly_charges` | COUNT, color by `churn` |
| Tenure vs. Churn | Line Chart | `tenure_months` | AVG(`churn`) |

#### Dashboard 2: Segment Analysis

1. Connect to `segment_summary.csv`
2. Create a **Highlight Table** with segment metrics
3. Create a **Bar Chart** of churn rate by business label
4. Add **Filters** for each segment to drill into details

#### Dashboard 3: Executive KPIs

1. Connect to `executive_kpi.csv`
2. Create **Big Number** tiles for each KPI
3. Use **Color** to highlight risk areas (red for Revenue At Risk)
4. Add the segment summary as a supporting table

### Step 3: Calculated Fields

Useful Tableau calculated fields:

```
// Risk Level
IF [churn] = 1 THEN "Churned" ELSE "Active" END

// Revenue Per Month
[total_charges] / [tenure_months]

// High Value Flag
IF [monthly_charges] > 80 THEN "High Value" ELSE "Standard" END

// Tenure Category
IF [tenure_months] <= 12 THEN "New"
ELSEIF [tenure_months] <= 36 THEN "Established"
ELSE "Loyal"
END
```

---

## Executive KPI Summary (JSON)

**Location:** `outputs/reports/executive_kpi_summary.json`

This is the most comprehensive KPI report, structured for programmatic consumption:

```json
{
  "business_metrics": {
    "total_customers": 100000,
    "overall_churn_rate": 0.498,
    "avg_monthly_revenue_per_customer": 69.13,
    "total_revenue": 6721234.56,
    "at_risk_customers": 49831,
    "potential_revenue_at_risk": 43568166.96
  },
  "model_performance": {
    "best_model": "xgboost",
    "accuracy": 0.8508,
    "roc_auc": 0.9328,
    "precision": 0.8496,
    "recall": 0.8523,
    "f1_score": 0.8509
  },
  "segmentation": {
    "num_segments": 4,
    "segments": [
      {
        "business_label": "At-Risk / High Spenders",
        "count": 29297,
        "churn_rate": 0.697
      },
      {
        "business_label": "New Power Users",
        "count": 9722,
        "churn_rate": 0.515
      },
      {
        "business_label": "Budget-Conscious",
        "count": 32736,
        "churn_rate": 0.429
      },
      {
        "business_label": "Loyal High-Value",
        "count": 19382,
        "churn_rate": 0.312
      }
    ]
  }
}
```

### KPI Definitions

#### Business Metrics

| KPI | Calculation | Business Meaning |
|-----|-------------|-----------------|
| **Total Customers** | `len(df)` | Size of customer base |
| **Overall Churn Rate** | `mean(churn)` | % of customers who left |
| **Avg Monthly Revenue** | `mean(monthly_charges)` | Average per-customer monthly revenue |
| **Total Revenue** | `sum(total_charges)` | Total lifetime revenue from all customers |
| **At-Risk Customers** | `sum(churn == 1)` | Number of customers who churned |
| **Revenue At Risk (Annual)** | `sum(monthly_charges where churn=1) * 12` | Annualized revenue that could be lost |

#### Model Performance Metrics

| KPI | Value Range | What It Means |
|-----|------------|---------------|
| **Accuracy** | 0-100% | Overall correct predictions |
| **ROC-AUC** | 0.5-1.0 | Model's discriminative ability (0.93 = excellent) |
| **Precision** | 0-100% | When we predict churn, how often are we right? |
| **Recall** | 0-100% | Of all churners, how many did we identify? |
| **F1 Score** | 0-100% | Balanced metric (harmonic mean of precision and recall) |

---

## Visualizations Generated

### 1. Churn Distribution (`churn_distribution.png`)

A 3-panel chart showing:
- **Left:** Bar chart of churn vs. no-churn counts
- **Center:** Box plot of monthly charges by churn status
- **Right:** Box plot of tenure by churn status

**Key insight:** Churners tend to have higher monthly charges and shorter tenure.

### 2. Confusion Matrices (`confusion_matrix_*.png`)

One per model (3 total). Shows the 4-cell matrix of True Positives, True Negatives, False Positives, False Negatives.

**How to read:** Darker blue = more observations. Diagonal = correct predictions.

### 3. ROC Curves (`roc_curves_comparison.png`)

All 3 models plotted on one chart. The curve closest to the top-left corner performs best. The diagonal line represents random guessing.

### 4. Feature Importance (`feature_importance_xgboost.png`)

Horizontal bar chart showing the top 15 features ranked by XGBoost importance score. Contract type and tenure dominate.

### 5. Elbow Method (`elbow_method.png`)

Shows inertia (within-cluster variance) decreasing as K increases. The "elbow" indicates the optimal number of clusters.

### 6. Silhouette Analysis (`silhouette_analysis.png`)

Shows silhouette scores for K=2 through K=10. Higher scores indicate better-defined clusters. A green vertical line marks the best K.

---

## Model Comparison Report

**Location:** `outputs/reports/model_comparison.csv`

| model_name | accuracy | precision | recall | f1_score | roc_auc |
|-----------|----------|-----------|--------|----------|---------|
| logistic_regression | 0.8447 | 0.8417 | 0.8487 | 0.8452 | 0.9244 |
| random_forest | 0.8395 | 0.8375 | 0.8422 | 0.8398 | 0.9225 |
| xgboost | 0.8508 | 0.8496 | 0.8523 | 0.8509 | 0.9328 |

The JSON version (`model_comparison.json`) additionally includes confusion matrices for each model.

---

## Refreshing BI Outputs

When you retrain the models, BI outputs are automatically regenerated:

```bash
python main.py  # Full pipeline + BI outputs
```

To regenerate only the BI outputs without retraining:

```python
from src.utils.bi_output import generate_all_bi_outputs
from src.data.ingestion import load_from_csv
from src.config.settings import RAW_DATA_DIR
import pandas as pd

raw_df = load_from_csv(RAW_DATA_DIR / "customer_churn_raw.csv")
comparison_df = pd.read_csv("outputs/reports/model_comparison.csv")
segment_profile = pd.read_csv("outputs/reports/segment_profiles.csv", index_col=0)

generate_all_bi_outputs(raw_df, comparison_df, segment_profile)
```

---

## Integration with Other BI Tools

### Power BI
Import the same CSV files using **Get Data → Text/CSV**. The file format is compatible.

### Google Data Studio / Looker
Upload CSVs as data sources or connect to the SQLite database.

### Programmatic Access (Python)
```python
import pandas as pd
import json

# Load Tableau dataset
df = pd.read_csv("outputs/tableau/churn_analysis_tableau.csv")

# Load KPIs
with open("outputs/reports/executive_kpi_summary.json") as f:
    kpis = json.load(f)

print(f"Churn Rate: {kpis['business_metrics']['overall_churn_rate']:.1%}")
print(f"Revenue at Risk: ${kpis['business_metrics']['potential_revenue_at_risk']:,.2f}")
```

### SQL Access
```sql
-- Connect to data/processed/churn_data.db
SELECT
    contract_type,
    COUNT(*) as total,
    SUM(churn) as churned,
    ROUND(AVG(churn) * 100, 1) as churn_rate_pct
FROM customer_data
GROUP BY contract_type
ORDER BY churn_rate_pct DESC;
```
